# 向量建模


### 一个简单的转场和一个简单的判断

我们从一个最简单的 Push 转场效果说起:

![](md/images/2019-11-25_17-21-06.jpg)

我的第一版是一个基于本能的实现: 

<pre class="language-ts">
if (x > progress) {
	...
}
else {
	...
}
</pre>

它能够解决问题, 除了边缘会产生跳动之外 (这需要通过 [滤波](#math/filtering) 解决).



### 平面几何模型

不过很快我遇到了第二个转场:

这会就没有那么简单了, 首先求运动方向上移动的距离就不是件容易事. 不过还好我很擅长平面几何, 所以我标了个角度然后很快建立了一个几何模型:

![](md/images/2019-11-25_17-21-14.jpg)

然后将那个平行于运动方向向前的推进线求出和 XY 轴的交点, 从而划分出新旧两个区域, 这个也不难嘛.

紧接着又遇到了其他各种方向和角度的同一个转场, 我很快明白了这不是一个事.



### 几何变换模型

所以我建了第三个模型:

![](md/images/2019-11-25_17-21-28.jpg)

这是一个处理对称的模型, 它可以把往左和往右的运动按照中轴做镜像, 或者把往左下的运动和往右下的做对称.

这个模型将可以对称的东西做了一致的处理, 比较遗憾的时坐标处理完成之后, 在采样之前, 还需要将之前的对称还原, 这也可以做一致的处理, 但是它增加了问题的复杂度.

我们还可以引入例如旋转或者通用的几何变换来进一步增加这个模型的可用范围, 然后坐标处理完之后再应用变换的逆矩阵来还原坐标.

然而你终归会发现它治标不治本. 直到我终于意识到这里实际需要一个向量模型.



### 向量模型

"当你发现你做了几遍同一件事情之后, 就说明你做的方式有问题. 这个时候你要把之前的经验合并起来然后寻找更加一致的东西了."

如果我们从运动的角度去观察, 这个转场的分隔线推进的过程, 可以归纳为从一个点, 按照一个方向移动到另一个点的过程.

![](md/images/2019-11-25_17-21-22.jpg)

所以我们只需要找到起始点, 结束点, 运动方向即可. 运动方向是预设的, 起始点很明显是运动方向的投影上最开始的那个点, 而结束点就是起始点斜对面的那个点在运动方向的投影.

然后我们判断当前点在运动方向上的投影是否超过当前转场的分隔线向量的长度即可.

之后, 通过大量的分析, 我基本确信, 只要有一致的运动方向, 那么就可以通过向量建模搞定.

熟练掌握向量建模需要时间去练习.

此外之前我一直认为 GLSL 的类型 `vec` 在处理 3D 场景时既然基本全部用来表示坐标, 那么干嘛不叫 `coord`? 此刻我才明白别人的用心良苦.

不过我个人还是建议有一个专门的 `coord` 类型, 因为 `vec` 实际上是 `coord - coord` 产生的, 实际应用中经常容易把两者搞混, 比如一个运动的最终坐标, 需要拿运动的原点加上运动向量, 但是很容易忘记了这个原点, 直接用向量当做坐标. 而且这类错误不太好检查 (除了用颜色输出信息之外, 目前我没发现其他更好的调试手段).



### 向量模型的选择

一般而言, 选择合适的向量模型能让问题通过投影到运动方向而转化成一个一维的问题, 然后就可以使用最简单的数学运算来解决.

有时候也可以通过将问题分别投影到两个轴上而将问题分解为两个一维的问题, 也可以将问题大大简化.

例如在分析网上找到的转场效果时, 有一个 6 角形网络, 我们需要找到任何一个点所处的 6 边形. 很明显, 6 个边不适合使用数学手段描述. 不过如果我们将它的中心连起来, 会形成一个三角形网络:

![](md/images/2019-11-25_17-21-44.jpg)

这个就容易通过数学手段描述了. 之后我们很容易注意到两个基底向量 $\nu1$ 和 $\nu2$, 并且可以确定一个原点:

![](md/images/2019-11-25_17-21-53.jpg)

你很容易发现其他顶点的向量都可以通过 $a\nu1 + b\nu2$ (a, b 为整数) 的方式表达出来.

然后很明显, 平面上任何一个向量也都可以通过 $a\nu1 + b\nu2$ (a, b 为实数) 的方式表达出来.

然后, 只要对 $a$, $b$ 进行上下取整再交叉就可以得到所处的四个顶点组成的范围, 然后再检查他们跟哪个顶点最近.

![](md/images/2019-11-25_17-22-01.jpg)
