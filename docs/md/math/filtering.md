# 滤波

滤波这个名词来自于数字信号处理, 一般用来表示滤除低频率或者高频率, 或者指定频率范围的数字波. 我在 `<<OpenGL 编程指南>>` 的反走样一章中第一次见到这个词.

滤波和平滑两个词是有区别, 我看到过一些情况下两个词被混淆. 平滑指的应该是边缘的过渡处理, 可以使用滤波也可以使用其他方式实现 (例如 MSAA), 而滤波是通用的信号的过滤处理, 可以实现平滑, 也可以实现其他的效果. 我们在此仅讨论用于平滑的滤波.



### GLSL 滤波函数

常用的 GLSL 滤波函数有 `step`, `smoothstep`.

![](md/images/2019-11-25_17-22-37.jpg)

`step` 在边缘会产生断层, 而 `smoothstep` 会在边缘的某个范围进行过渡.

通过组合这些滤波函数, 可以也可以自定义更多的滤波函数, 例如一个两端平滑下降的滤波函数:

![](md/images/2019-11-25_17-22-49.jpg)



### 还是那个简单的转场

在上一节 [向量模型](#math/vector-modeling) 中, 我们那个最简单的 Push 转场, 在实现之后会发现边缘有跳动, 其实就是逐渐递进的现象. 它产生的原因非常简单, 就是我们使用逻辑判断一个像素属于新图还是旧图, 并且只会是新图或者旧图, 所以这个转场便会一像素一像素地推进:

![](md/images/2019-11-25_17-22-10.jpg)

因为前进速度和屏幕刷新的速度不同步, 所以可能前两帧我们看到它完全没动, 但是下一帧却突然移动了 1px, 这就是为何它会产生跳动.

这其实并不要命, 因为 1px 递进的变化即使被留意到, 也影响不大, 因为它只是看起来不流畅, 但是并不扎眼.

要命的是另一类问题: 晃动, 接缝. 不过碰到这些问题刚好可以锻炼自己的滤波处理技巧.



### 边缘平滑和过渡

一般只需要在边缘的 1px 范围做平滑, 效果就会很好.

我们也可以增大这个范围, 让边缘逐渐过渡到另一个图像, 而形成边缘的一个渐变过渡效果. 这里可以做的文章非常多, 有许多的看起来匪夷所思的东西, 起关键作用的可能就是一个简单的滤波函数.

这是我们的一个的滤波函数, 它会在 1px 的范围进行平滑.

![](md/images/2019-11-25_17-22-55.jpg)

以下是一个滤波函数的一般的建立步骤:
- 建模方式: 我们需要首先确定我们的建模方式 - 即针对哪个变量进行滤波, 也就是, 这个图像的 x 轴到底是谁.
- 哪里平滑: 然后我们需要知道从哪里进行平滑, 即变量所对应的边界在哪里.
- 平滑范围: 之后, 我们需要确定我们在哪个范围进行 1px 的平滑, 即平滑范围的上下界. 这个范围一般使用边界作为中值. 很明显这是上述变量对于栅格化像素坐标的偏导数.

同一个案例会有不同的建模方式, 模型的选择对于滤波的复杂度有着非常直接的影响, 一般而言, 我们应该围绕着边缘去建模. 即处于边缘时, 针对滤波的变量的值是一致的.



### 一个滤波的案例 - 绘制圆形

例如我们需要绘制一个指定半径 R 的圆形, 假设会栅格化为半径 R' 的圆, 很明显:
- 建模方式: 圆心加距离圆心的距离 l.
- 哪里平滑: 从 l 变量的 R 位置附近开始平滑.
- 平滑范围: 很明显 1px 对应 l 的变化固定为 R/R', 因此我们建立一个滤波函数: `1 - smoothstep(R - R / 2R', R + R / 2R', l)`. 这个滤波函数能够保证对圆的边缘 1px 范围平滑.



### 另一个滤波的案例 - 绘制矩形

再例如我们需要绘制一个矩形, 这个矩形可能会缩放, 旋转. 一般会有两种建模方式:

其一, 建模为到边界的距离, 在矩形外为负值. 处理方式和上面的圆形几乎相同.

其二, 建模为矩形内坐标, 例如 x 和 y, 范围均为 0~1.
- 建模方式: 坐标建模, 这是最自然的方式.
- 哪里平滑: x, y = 0 / 1.
- 平滑范围: 因为涉及到两个变量, 我们知道在两个方向上的矩形坐标相对于栅格化像素坐标偏导数, 这两个偏导数构成梯度向量, 向量的值就是最终的平滑范围.

更复杂的情况下, 例如矩形有透视变换, 并且不同位置的深度不同. 此时计算平滑范围比较复杂 (但是可以计算出来, 通过几何或者向量方法), 此时, 可以简单使用 GLSL 的梯度函数. 需要注意使用梯度函数会导致相邻片元产生同步, 对于计算性能有一定的影响, 但是实测并不大.



### GLSL 中的梯度函数

GLSL 为我们提供了三个 API: `dFdx`, `dFdy`, `fwidth`.

`dFdx`, `dFdy` 分别代表了在 X 和 Y 方向, 片元位置变化 1px 时的指定变量的变化量 (偏导数), 他们的绝对值的和, 即 $\textit{fwidth} = |dFdx| + |dFdy|$, 近似于梯度向量模长.

所以我们可以使用 `fwidth(variable)` 来表示 `variable` 的平滑区间长度, 来刚好在 1px 范围内平滑.



### 梯度函数的解释

我们假设在像素坐标系内变化了 1px, 那么我们怎么知道用来滤波的变量的对应的变化范围, 从而确定滤波的平滑区间呢?

答案是梯度, 准确来说是某个变量对于栅格化时的像素坐标, 包括了 XY 两个方向的偏导数, 这两个偏导数构成了一个梯度向量, 其指向最速下降方向以及其梯度值.

我觉得梯度这个名词很形象, 因为你一看到它就知道它的意思是它代表了一个面的倾斜程度, 然后你坐上去还可以滑下来, 梯度越大, 你滑下去越快, 爬上来也越难.

如果在 X 轴内变化了 1px (准确来说是梯度方向上变化了 1px), 那么我们的滤波变量的变化量在像素坐标系内会刚好是这个梯度 (注意它的单位是 px, 可能需要转为变量所在坐标系). 这个不太好理解, 我们举个例子:

![](md/images/2019-11-25_17-23-03.jpg)

我们只举出一个一维梯度的例子: 把一张纸竖起来和地面成 $60^\circ$ 角, 这时候的梯度值为 $\tan 60^\circ = \sqrt{3}$, 在横向每变化 1 时, 纵向会变化 1.73.

所以我们最终的平滑范围即为变量的梯度值.


